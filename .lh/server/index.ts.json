{
    "sourceFile": "server/index.ts",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 25,
            "patches": [
                {
                    "date": 1763988509840,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1763988522258,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -48,8 +48,30 @@\n app.get('/api/health', (req, res) => {\r\n   res.json({ status: 'ok' });\r\n });\r\n \r\n+// Tournament management\r\n+app.get('/api/tournaments', (req, res) => {\r\n+  const tournamentList = Array.from(tournaments.values()).map(t => ({\r\n+    id: t.id,\r\n+    name: t.name,\r\n+    state: t.state,\r\n+    playerCount: t.players.length\r\n+  }));\r\n+  res.json(tournamentList);\r\n+});\r\n+\r\n+app.post('/api/tournaments', async (req, res) => {\r\n+  const { name } = req.body;\r\n+  if (!name) return res.status(400).json({ error: 'Name is required' });\r\n+  const id = uuidv4();\r\n+  const tournament = new TournamentManager(id, name);\r\n+  tournaments.set(id, tournament);\r\n+  await redisClient.sAdd('tournaments:list', id);\r\n+  await saveState(id);\r\n+  res.json({ id, name });\r\n+});\r\n+\r\n app.get('/api/state', (req, res) => {\r\n     console.log('[API] GET /api/state - Returning tournament state');\r\n     res.json(tournament);\r\n });\r\n"
                },
                {
                    "date": 1763988532482,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -75,13 +75,16 @@\n     console.log('[API] GET /api/state - Returning tournament state');\r\n     res.json(tournament);\r\n });\r\n \r\n-app.post('/api/players', async (req, res) => {\r\n+app.post('/api/tournament/:tournamentId/players', async (req, res) => {\r\n+    const { tournamentId } = req.params;\r\n+    const tournament = tournaments.get(tournamentId);\r\n+    if (!tournament) return res.status(404).json({ error: 'Tournament not found' });\r\n     const { name } = req.body;\r\n     if (!name) return res.status(400).json({ error: 'Name is required' });\r\n     const player = tournament.addPlayer(name);\r\n-    await saveState();\r\n+    await saveState(tournamentId);\r\n     res.json(player);\r\n });\r\n \r\n app.post('/api/start', async (req, res) => {\r\n"
                },
                {
                    "date": 1763988542063,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -96,19 +96,21 @@\n         res.status(400).json({ error: e.message });\r\n     }\r\n });\r\n \r\n-app.post('/api/match/:id', async (req, res) => {\r\n-    const { id } = req.params;\r\n+app.post('/api/tournament/:tournamentId/match/:id', async (req, res) => {\r\n+    const { tournamentId, id } = req.params;\r\n+    const tournament = tournaments.get(tournamentId);\r\n+    if (!tournament) return res.status(404).json({ error: 'Tournament not found' });\r\n     const { results } = req.body;\r\n-    console.log('[API] POST /api/match/:id - Received:', { id, results });\r\n+    console.log(`[API] POST /api/tournament/${tournamentId}/match/${id} - Received:`, { id, results });\r\n     try {\r\n         tournament.submitMatchResult(id, results);\r\n-        await saveState();\r\n-        console.log('[API] POST /api/match/:id - Success, state saved');\r\n+        await saveState(tournamentId);\r\n+        console.log(`[API] POST /api/tournament/${tournamentId}/match/${id} - Success, state saved`);\r\n         res.json({ success: true });\r\n     } catch (e: any) {\r\n-        console.error('[API] POST /api/match/:id - Error:', e.message);\r\n+        console.error(`[API] POST /api/tournament/${tournamentId}/match/${id} - Error:`, e.message);\r\n         res.status(400).json({ error: e.message });\r\n     }\r\n });\r\n \r\n"
                },
                {
                    "date": 1763988551815,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -123,14 +123,16 @@\n         res.status(400).json({ error: e.message });\r\n     }\r\n });\r\n \r\n-app.post('/api/bracket-match/:id', async (req, res) => {\r\n-    const { id } = req.params;\r\n+app.post('/api/tournament/:tournamentId/bracket-match/:id', async (req, res) => {\r\n+    const { tournamentId, id } = req.params;\r\n+    const tournament = tournaments.get(tournamentId);\r\n+    if (!tournament) return res.status(404).json({ error: 'Tournament not found' });\r\n     const { winnerId } = req.body;\r\n     try {\r\n         tournament.submitBracketWinner(id, winnerId);\r\n-        await saveState();\r\n+        await saveState(tournamentId);\r\n         res.json({ success: true });\r\n     } catch (e: any) {\r\n         res.status(400).json({ error: e.message });\r\n     }\r\n"
                },
                {
                    "date": 1763988561890,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -36,10 +36,13 @@\n     }\r\n   }\r\n })();\r\n \r\n-const saveState = async () => {\r\n-    await redisClient.set('tournament_state', JSON.stringify(tournament));\r\n+const saveState = async (tournamentId: string) => {\r\n+    const tournament = tournaments.get(tournamentId);\r\n+    if (tournament) {\r\n+        await redisClient.set(`tournament:${tournamentId}`, JSON.stringify(tournament));\r\n+    }\r\n };\r\n \r\n app.use(cors());\r\n app.use(bodyParser.json());\r\n"
                },
                {
                    "date": 1763988572393,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -116,12 +116,15 @@\n         res.status(400).json({ error: e.message });\r\n     }\r\n });\r\n \r\n-app.post('/api/brackets', async (req, res) => {\r\n+app.post('/api/tournament/:tournamentId/brackets', async (req, res) => {\r\n+    const { tournamentId } = req.params;\r\n+    const tournament = tournaments.get(tournamentId);\r\n+    if (!tournament) return res.status(404).json({ error: 'Tournament not found' });\r\n     try {\r\n         tournament.generateBrackets();\r\n-        await saveState();\r\n+        await saveState(tournamentId);\r\n         res.json({ success: true });\r\n     } catch (e: any) {\r\n         res.status(400).json({ error: e.message });\r\n     }\r\n"
                },
                {
                    "date": 1763988582513,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -73,13 +73,10 @@\n   await saveState(id);\r\n   res.json({ id, name });\r\n });\r\n \r\n-app.get('/api/state', (req, res) => {\r\n-    console.log('[API] GET /api/state - Returning tournament state');\r\n-    res.json(tournament);\r\n-});\r\n \r\n+\r\n app.post('/api/tournament/:tournamentId/players', async (req, res) => {\r\n     const { tournamentId } = req.params;\r\n     const tournament = tournaments.get(tournamentId);\r\n     if (!tournament) return res.status(404).json({ error: 'Tournament not found' });\r\n"
                },
                {
                    "date": 1763988592250,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -140,15 +140,18 @@\n         res.status(400).json({ error: e.message });\r\n     }\r\n });\r\n \r\n-app.post('/api/reset', async (req, res) => {\r\n+app.post('/api/tournament/:tournamentId/reset', async (req, res) => {\r\n+    const { tournamentId } = req.params;\r\n+    const tournament = tournaments.get(tournamentId);\r\n+    if (!tournament) return res.status(404).json({ error: 'Tournament not found' });\r\n     tournament.players = [];\r\n     tournament.pods = [];\r\n     tournament.matches = [];\r\n     tournament.bracketMatches = [];\r\n     tournament.state = 'registration';\r\n-    await saveState();\r\n+    await saveState(tournamentId);\r\n     res.json({ success: true });\r\n });\r\n \r\n \r\n"
                },
                {
                    "date": 1763989265846,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -86,12 +86,15 @@\n     await saveState(tournamentId);\r\n     res.json(player);\r\n });\r\n \r\n-app.post('/api/start', async (req, res) => {\r\n+app.post('/api/tournament/:tournamentId/start', async (req, res) => {\r\n+    const { tournamentId } = req.params;\r\n+    const tournament = tournaments.get(tournamentId);\r\n+    if (!tournament) return res.status(404).json({ error: 'Tournament not found' });\r\n     try {\r\n         tournament.startGroupStage();\r\n-        await saveState();\r\n+        await saveState(tournamentId);\r\n         res.json({ success: true });\r\n     } catch (e: any) {\r\n         res.status(400).json({ error: e.message });\r\n     }\r\n"
                },
                {
                    "date": 1763989932005,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -73,10 +73,27 @@\n   await saveState(id);\r\n   res.json({ id, name });\r\n });\r\n \r\n+// Get tournament state\r\n+app.get('/api/tournament/:tournamentId/state', (req, res) => {\r\n+  const { tournamentId } = req.params;\r\n+  const tournament = tournaments.get(tournamentId);\r\n+  if (!tournament) return res.status(404).json({ error: 'Tournament not found' });\r\n \r\n+  res.json({\r\n+    id: tournament.id,\r\n+    name: tournament.name,\r\n+    players: tournament.players,\r\n+    pods: tournament.pods,\r\n+    matches: tournament.matches,\r\n+    bracketMatches: tournament.bracketMatches,\r\n+    state: tournament.state\r\n+  });\r\n+});\r\n \r\n+\r\n+\r\n app.post('/api/tournament/:tournamentId/players', async (req, res) => {\r\n     const { tournamentId } = req.params;\r\n     const tournament = tournaments.get(tournamentId);\r\n     if (!tournament) return res.status(404).json({ error: 'Tournament not found' });\r\n"
                },
                {
                    "date": 1764013161019,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -173,9 +173,40 @@\n     await saveState(tournamentId);\r\n     res.json({ success: true });\r\n });\r\n \r\n+// Update group name\r\n+app.put('/api/tournament/:tournamentId/group/:podId/name', async (req, res) => {\r\n+    const { tournamentId, podId } = req.params;\r\n+    const { name } = req.body;\r\n+    const tournament = tournaments.get(tournamentId);\r\n+    if (!tournament) return res.status(404).json({ error: 'Tournament not found' });\r\n \r\n+    try {\r\n+        tournament.updateGroupName(podId, name);\r\n+        await saveState(tournamentId);\r\n+        res.json({ success: true });\r\n+    } catch (e: any) {\r\n+        res.status(400).json({ error: e.message });\r\n+    }\r\n+});\r\n+\r\n+// Reset group data\r\n+app.post('/api/tournament/:tournamentId/group/:podId/reset', async (req, res) => {\r\n+    const { tournamentId, podId } = req.params;\r\n+    const tournament = tournaments.get(tournamentId);\r\n+    if (!tournament) return res.status(404).json({ error: 'Tournament not found' });\r\n+\r\n+    try {\r\n+        tournament.resetGroupData(podId);\r\n+        await saveState(tournamentId);\r\n+        res.json({ success: true });\r\n+    } catch (e: any) {\r\n+        res.status(400).json({ error: e.message });\r\n+    }\r\n+});\r\n+\r\n+\r\n // Serve static files from the Svelte app build\r\n const __filename = fileURLToPath(import.meta.url);\r\n const __dirname = path.dirname(__filename);\r\n // In production (docker), dist is at /app/dist. In dev, it might be different.\r\n"
                },
                {
                    "date": 1764016782201,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -173,8 +173,24 @@\n     await saveState(tournamentId);\r\n     res.json({ success: true });\r\n });\r\n \r\n+// Update tournament name\r\n+app.put('/api/tournament/:tournamentId/name', async (req, res) => {\r\n+    const { tournamentId } = req.params;\r\n+    const { name } = req.body;\r\n+    const tournament = tournaments.get(tournamentId);\r\n+    if (!tournament) return res.status(404).json({ error: 'Tournament not found' });\r\n+\r\n+    try {\r\n+        tournament.updateTournamentName(name);\r\n+        await saveState(tournamentId);\r\n+        res.json({ success: true });\r\n+    } catch (e: any) {\r\n+        res.status(400).json({ error: e.message });\r\n+    }\r\n+});\r\n+\r\n // Update group name\r\n app.put('/api/tournament/:tournamentId/group/:podId/name', async (req, res) => {\r\n     const { tournamentId, podId } = req.params;\r\n     const { name } = req.body;\r\n"
                },
                {
                    "date": 1764017119818,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -73,8 +73,25 @@\n   await saveState(id);\r\n   res.json({ id, name });\r\n });\r\n \r\n+// Delete a tournament\r\n+app.delete('/api/tournament/:tournamentId', async (req, res) => {\r\n+    const { tournamentId } = req.params;\r\n+    if (!tournaments.has(tournamentId)) {\r\n+        return res.status(404).json({ error: 'Tournament not found' });\r\n+    }\r\n+\r\n+    try {\r\n+        tournaments.delete(tournamentId);\r\n+        await redisClient.sRem('tournaments:list', tournamentId);\r\n+        await redisClient.del(`tournament:${tournamentId}`);\r\n+        res.json({ success: true, message: `Tournament ${tournamentId} deleted.` });\r\n+    } catch (e: any) {\r\n+        res.status(500).json({ error: 'Failed to delete tournament', details: e.message });\r\n+    }\r\n+});\r\n+\r\n // Get tournament state\r\n app.get('/api/tournament/:tournamentId/state', (req, res) => {\r\n   const { tournamentId } = req.params;\r\n   const tournament = tournaments.get(tournamentId);\r\n"
                },
                {
                    "date": 1764018283781,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -237,8 +237,22 @@\n         res.status(400).json({ error: e.message });\r\n     }\r\n });\r\n \r\n+// Update a player's name\r\n+app.put('/api/tournament/:tournamentId/player/:playerId', async (req, res) => {\r\n+  const { tournamentId, playerId } = req.params;\r\n+  const { name } = req.body;\r\n+  const tournament = tournaments.get(tournamentId);\r\n+  if (!tournament) return res.status(404).json({ error: 'Tournament not found' });\r\n+  try {\r\n+    tournament.updatePlayerName(playerId, name);\r\n+    await saveState(tournamentId);\r\n+    res.json({ success: true });\r\n+  } catch (e: any) {\r\n+    res.status(400).json({ error: e.message });\r\n+  }\r\n+});\r\n \r\n // Serve static files from the Svelte app build\r\n const __filename = fileURLToPath(import.meta.url);\r\n const __dirname = path.dirname(__filename);\r\n"
                },
                {
                    "date": 1764026838741,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -252,8 +252,23 @@\n     res.status(400).json({ error: e.message });\r\n   }\r\n });\r\n \r\n+// Update player photo\r\n+app.put('/api/tournament/:tournamentId/player/:playerId/photo', async (req, res) => {\r\n+  const { tournamentId, playerId } = req.params;\r\n+  const { photo } = req.body;\r\n+  const tournament = tournaments.get(tournamentId);\r\n+  if (!tournament) return res.status(404).json({ error: 'Tournament not found' });\r\n+  try {\r\n+    tournament.updatePlayerPhoto(playerId, photo);\r\n+    await saveState(tournamentId);\r\n+    res.json({ success: true });\r\n+  } catch (e: any) {\r\n+    res.status(400).json({ error: e.message });\r\n+  }\r\n+});\r\n+\r\n // Serve static files from the Svelte app build\r\n const __filename = fileURLToPath(import.meta.url);\r\n const __dirname = path.dirname(__filename);\r\n // In production (docker), dist is at /app/dist. In dev, it might be different.\r\n"
                },
                {
                    "date": 1764030267337,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -44,9 +44,9 @@\n     }\r\n };\r\n \r\n app.use(cors());\r\n-app.use(bodyParser.json());\r\n+app.use(bodyParser.json({ limit: '10mb' })); // Increase limit to 10MB for photo uploads\r\n \r\n // API Routes\r\n app.get('/api/health', (req, res) => {\r\n   res.json({ status: 'ok' });\r\n"
                },
                {
                    "date": 1764074503636,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -4,8 +4,10 @@\n import bodyParser from 'body-parser';\r\n import path from 'path';\r\n import { fileURLToPath } from 'url';\r\n import { v4 as uuidv4 } from 'uuid';\r\n+import session from 'express-session';\r\n+import RedisStore from 'connect-redis';\r\n \r\n import { TournamentManager } from './tournament.js';\r\n \r\n const app = express();\r\n@@ -44,10 +46,19 @@\n     }\r\n };\r\n \r\n app.use(cors());\r\n-app.use(bodyParser.json({ limit: '10mb' })); // Increase limit to 10MB for photo uploads\r\n+app.use(bodyParser.json({ limit: '10mb' })); \r\n \r\n+// Session middleware (requires npm install express-session connect-redis)\r\n+app.use(session({\r\n+  store: new RedisStore({ client: redisClient }),\r\n+  secret: 'your-secret-key', // Change to a secure key\r\n+  resave: false,\r\n+  saveUninitialized: false,\r\n+  cookie: { secure: false } // Set to true in production with HTTPS\r\n+}));\r\n+\r\n // API Routes\r\n app.get('/api/health', (req, res) => {\r\n   res.json({ status: 'ok' });\r\n });\r\n@@ -120,9 +131,39 @@\n     await saveState(tournamentId);\r\n     res.json(player);\r\n });\r\n \r\n-app.post('/api/tournament/:tournamentId/start', async (req, res) => {\r\n+app.post('/api/login', (req, res) => {\r\n+  const { password } = req.body;\r\n+  if (password === 'admin123') { // Hardcoded for demo; use env var or DB\r\n+    req.session.admin = true;\r\n+    res.json({ success: true });\r\n+  } else {\r\n+    res.status(401).json({ error: 'Invalid password' });\r\n+  }\r\n+});\r\n+\r\n+app.post('/api/logout', (req, res) => {\r\n+  req.session.destroy(() => {\r\n+    res.json({ success: true });\r\n+  });\r\n+});\r\n+\r\n+app.get('/api/admin/status', (req, res) => {\r\n+  res.json({ isAdmin: !!req.session.admin });\r\n+});\r\n+\r\n+// Middleware to protect edit routes\r\n+function requireAdmin(req: any, res: any, next: any) {\r\n+  if (req.session.admin) {\r\n+    next();\r\n+  } else {\r\n+    res.status(403).json({ error: 'Admin access required' });\r\n+  }\r\n+}\r\n+\r\n+// Protect edit routes (example for starting tournament)\r\n+app.post('/api/tournament/:tournamentId/start', requireAdmin, async (req, res) => {\r\n     const { tournamentId } = req.params;\r\n     const tournament = tournaments.get(tournamentId);\r\n     if (!tournament) return res.status(404).json({ error: 'Tournament not found' });\r\n     try {\r\n"
                },
                {
                    "date": 1764075119894,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -7,8 +7,15 @@\n import { v4 as uuidv4 } from 'uuid';\r\n import session from 'express-session';\r\n import RedisStore from 'connect-redis';\r\n \r\n+// Add session types to Express Request\r\n+declare module 'express-serve-static-core' {\r\n+  interface Request {\r\n+    session: session.Session & Partial<session.SessionData>;\r\n+  }\r\n+}\r\n+\r\n import { TournamentManager } from './tournament.js';\r\n \r\n const app = express();\r\n const port = 3000;\r\n"
                },
                {
                    "date": 1764075219460,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -5,9 +5,9 @@\n import path from 'path';\r\n import { fileURLToPath } from 'url';\r\n import { v4 as uuidv4 } from 'uuid';\r\n import session from 'express-session';\r\n-import RedisStore from 'connect-redis';\r\n+import { RedisStore } from 'connect-redis';\r\n \r\n // Add session types to Express Request\r\n declare module 'express-serve-static-core' {\r\n   interface Request {\r\n"
                },
                {
                    "date": 1764075232276,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -14,8 +14,14 @@\n     session: session.Session & Partial<session.SessionData>;\r\n   }\r\n }\r\n \r\n+declare module 'express-session' {\r\n+  interface SessionData {\r\n+    admin?: boolean;\r\n+  }\r\n+}\r\n+\r\n import { TournamentManager } from './tournament.js';\r\n \r\n const app = express();\r\n const port = 3000;\r\n"
                },
                {
                    "date": 1764075386394,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -5,9 +5,9 @@\n import path from 'path';\r\n import { fileURLToPath } from 'url';\r\n import { v4 as uuidv4 } from 'uuid';\r\n import session from 'express-session';\r\n-import { RedisStore } from 'connect-redis';\r\n+import RedisStore from 'connect-redis';\r\n \r\n // Add session types to Express Request\r\n declare module 'express-serve-static-core' {\r\n   interface Request {\r\n"
                },
                {
                    "date": 1764075453626,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -19,8 +19,9 @@\n   interface SessionData {\r\n     admin?: boolean;\r\n   }\r\n }\r\n+declare module 'connect-redis';\r\n \r\n import { TournamentManager } from './tournament.js';\r\n \r\n const app = express();\r\n"
                },
                {
                    "date": 1764075599707,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -19,11 +19,10 @@\n   interface SessionData {\r\n     admin?: boolean;\r\n   }\r\n }\r\n-declare module 'connect-redis';\r\n \r\n-import { TournamentManager } from './tournament.js';\r\n+// import { TournamentManager } from './tournament.js';\r\n \r\n const app = express();\r\n const port = 3000;\r\n \r\n@@ -64,9 +63,9 @@\n app.use(bodyParser.json({ limit: '10mb' })); \r\n \r\n // Session middleware (requires npm install express-session connect-redis)\r\n app.use(session({\r\n-  store: new RedisStore({ client: redisClient }),\r\n+  store: new (RedisStore as any)({ client: redisClient }),\r\n   secret: 'your-secret-key', // Change to a secure key\r\n   resave: false,\r\n   saveUninitialized: false,\r\n   cookie: { secure: false } // Set to true in production with HTTPS\r\n"
                },
                {
                    "date": 1764075693236,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -20,9 +20,9 @@\n     admin?: boolean;\r\n   }\r\n }\r\n \r\n-// import { TournamentManager } from './tournament.js';\r\n+import { TournamentManager } from './tournament.js';\r\n \r\n const app = express();\r\n const port = 3000;\r\n \r\n"
                },
                {
                    "date": 1764075755189,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -20,8 +20,10 @@\n     admin?: boolean;\r\n   }\r\n }\r\n \r\n+declare module 'connect-redis';\r\n+\r\n import { TournamentManager } from './tournament.js';\r\n \r\n const app = express();\r\n const port = 3000;\r\n"
                }
            ],
            "date": 1763988509840,
            "name": "Commit-0",
            "content": "import express from 'express';\r\nimport { createClient } from 'redis';\r\nimport cors from 'cors';\r\nimport bodyParser from 'body-parser';\r\nimport path from 'path';\r\nimport { fileURLToPath } from 'url';\r\nimport { v4 as uuidv4 } from 'uuid';\r\n\r\nimport { TournamentManager } from './tournament.js';\r\n\r\nconst app = express();\r\nconst port = 3000;\r\n\r\n// Redis Client\r\nconst redisUrl = process.env.REDIS_URL || 'redis://localhost:6379';\r\nconst redisClient = createClient({ url: redisUrl });\r\n\r\nredisClient.on('error', (err) => console.log('Redis Client Error', err));\r\n\r\nconst tournaments: Map<string, TournamentManager> = new Map();\r\n\r\n(async () => {\r\n  await redisClient.connect();\r\n  console.log('Connected to Redis');\r\n\r\n  // Load tournament list from Redis\r\n  const tournamentIds = await redisClient.sMembers('tournaments:list');\r\n  for (const id of tournamentIds) {\r\n    const state = await redisClient.get(`tournament:${id}`);\r\n    if (state) {\r\n      const data = JSON.parse(state);\r\n      const tournament = new TournamentManager(data.id, data.name);\r\n      Object.assign(tournament, data);\r\n      tournaments.set(id, tournament);\r\n      console.log(`Loaded tournament: ${data.name} (${id})`);\r\n    }\r\n  }\r\n})();\r\n\r\nconst saveState = async () => {\r\n    await redisClient.set('tournament_state', JSON.stringify(tournament));\r\n};\r\n\r\napp.use(cors());\r\napp.use(bodyParser.json());\r\n\r\n// API Routes\r\napp.get('/api/health', (req, res) => {\r\n  res.json({ status: 'ok' });\r\n});\r\n\r\napp.get('/api/state', (req, res) => {\r\n    console.log('[API] GET /api/state - Returning tournament state');\r\n    res.json(tournament);\r\n});\r\n\r\napp.post('/api/players', async (req, res) => {\r\n    const { name } = req.body;\r\n    if (!name) return res.status(400).json({ error: 'Name is required' });\r\n    const player = tournament.addPlayer(name);\r\n    await saveState();\r\n    res.json(player);\r\n});\r\n\r\napp.post('/api/start', async (req, res) => {\r\n    try {\r\n        tournament.startGroupStage();\r\n        await saveState();\r\n        res.json({ success: true });\r\n    } catch (e: any) {\r\n        res.status(400).json({ error: e.message });\r\n    }\r\n});\r\n\r\napp.post('/api/match/:id', async (req, res) => {\r\n    const { id } = req.params;\r\n    const { results } = req.body;\r\n    console.log('[API] POST /api/match/:id - Received:', { id, results });\r\n    try {\r\n        tournament.submitMatchResult(id, results);\r\n        await saveState();\r\n        console.log('[API] POST /api/match/:id - Success, state saved');\r\n        res.json({ success: true });\r\n    } catch (e: any) {\r\n        console.error('[API] POST /api/match/:id - Error:', e.message);\r\n        res.status(400).json({ error: e.message });\r\n    }\r\n});\r\n\r\napp.post('/api/brackets', async (req, res) => {\r\n    try {\r\n        tournament.generateBrackets();\r\n        await saveState();\r\n        res.json({ success: true });\r\n    } catch (e: any) {\r\n        res.status(400).json({ error: e.message });\r\n    }\r\n});\r\n\r\napp.post('/api/bracket-match/:id', async (req, res) => {\r\n    const { id } = req.params;\r\n    const { winnerId } = req.body;\r\n    try {\r\n        tournament.submitBracketWinner(id, winnerId);\r\n        await saveState();\r\n        res.json({ success: true });\r\n    } catch (e: any) {\r\n        res.status(400).json({ error: e.message });\r\n    }\r\n});\r\n\r\napp.post('/api/reset', async (req, res) => {\r\n    tournament.players = [];\r\n    tournament.pods = [];\r\n    tournament.matches = [];\r\n    tournament.bracketMatches = [];\r\n    tournament.state = 'registration';\r\n    await saveState();\r\n    res.json({ success: true });\r\n});\r\n\r\n\r\n// Serve static files from the Svelte app build\r\nconst __filename = fileURLToPath(import.meta.url);\r\nconst __dirname = path.dirname(__filename);\r\n// In production (docker), dist is at /app/dist. In dev, it might be different.\r\n// We'll assume the server is run from the root or we adjust the path.\r\n// If running with ts-node from root:\r\napp.use(express.static(path.join(process.cwd(), 'dist')));\r\n\r\napp.get(/.*/, (req, res) => {\r\n    if (req.path.startsWith('/api')) {\r\n        return res.status(404).json({ error: 'API endpoint not found' });\r\n    }\r\n    res.sendFile(path.join(process.cwd(), 'dist', 'index.html'));\r\n});\r\n\r\napp.listen(port, () => {\r\n  console.log(`Server running at http://localhost:${port}`);\r\n});\r\n"
        }
    ]
}